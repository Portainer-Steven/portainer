name: ci

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - "*"
  #     - "*/*"
  #     - "!master"
  # pull_request:
  #   branches:
  #     - "*"

env:
  CONTINAER_IMAGE_TAG: pr${{ github.event.pull_request.labels.name }}
  NODE_ENV: testing

jobs:
  build_artefacts:
    strategy:
      matrix:
        config:
          - { platform: linux, arch: amd64 }
          - { platform: linux, arch: arm64 }
          - { platform: windows, arch: amd64 }
    runs-on: ubuntu-latest
    steps:
      - name: "[preparation] checkout the current branch"
        uses: actions/checkout@v3.5.3
      - name: "[preparation] set up golang 1.19.5"
        uses: actions/setup-go@v4.0.1
        with:
          go-version: "1.19.5"
      - name: "[preparation] set up node.js 18.x"
        uses: actions/setup-node@v2.5.2
        with:
          node-version: "18.x"
      - name: "[execution] build linux & windows portainer binaries"
        run: |
          make build-all PLATFORM=${{ matrix.platform }} ARCH=${{ matrix.arch }} ENV=${NODE_ENV}
      - name: "[post] upload artefact"
        uses: actions/upload-artifact@v3.1.2
        with:
          name: dist_${{ matrix.platform }}_${{ matrix.arch }}
          path: dist/*

  build_images:
    needs: [ build_artefacts ]
    strategy:
      matrix:
        config:
          - { platform: linux, arch: amd64 }
          - { platform: linux, arch: arm64 }
          - { platform: windows,arch: amd64, version: 1809 }
          - { platform: windows,arch: amd64, version: ltsc2022 }
    runs-on: ubuntu-latest
    steps:
      - name: "[preparation] checkout the current branch"
        uses: actions/checkout@v3.5.3
      - name: "[preparation] extract the branch name"
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch
      - name: "[preparation] set up qemu"
        uses: docker/setup-qemu-action@v2
      - name: "[preparation] set up docker buildx"
        uses: docker/setup-buildx-action@v2
      - name: "[preparation] download artifact"
        uses: actions/download-artifact@v3.0.2
        with:
          name: dist_${{ matrix.platform }}_${{ matrix.arch }}
      # - name: "[preparation] docker login"
      #   uses: docker/login-action@v2.2.0
      #   with:
      #     username: ${{ secrets.DOCKER_HUB_USERNAME }}
      #     password: ${{ secrets.DOCKER_HUB_PASSWORD }}
      - name: "[execution] build docker images"
        env:
          if: github.event.pull_request.labels.name == ''
          CONTAINER_IMAGE_TAG: ${{ steps.extract_branch.outputs.branch }}
        run: |
          ls -latrh
          if [ "${{ matrix.config.platform }}" == "windows" ]; then
            CONTAINER_IMAGE_TAG="${CONTAINER_IMAGE_TAG}-${{ matrix.config.platform }}${{ matrix.config.version }}-${{ matrix.config.arch }}"
          else 
            CONTAINER_IMAGE_TAG="${CONTAINER_IMAGE_TAG}-${{ matrix.config.platform }}-${{ matrix.config.arch }}"
            docker buildx build --load --platform ${{ matrix.config.platform }}/${{ matrix.config.arch }} -t "portainerci/portainer-ce:${CONTAINER_IMAGE_TAG}-alpine" -f build/${{ matrix.config.platform }}/alpine.Dockerfile .
          fi
          
          docker buildx build --load --platform ${{ matrix.config.platform }}/${{ matrix.config.arch }} -t "portainerci/portainer-ce:${CONTAINER_IMAGE_TAG}" -f build/${{ matrix.config.platform }}/Dockerfile .

          docker image ls
  
  build_manifests:
    runs-on: ubuntu-18.04
    needs: build_images
    steps:
      - name: Extract branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_branch

      - name: Docker Login
        uses: Azure/docker-login@v1
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          # login-server: # default is https://index.docker.io/v1/

      - name: Build and Push Manifests
        env:
          if: github.event.pull_request.labels.name == ''
          CONTAINER_IMAGE_TAG: ${{ steps.extract_branch.outputs.branch }}
        run: |
          sed -i 's/}}/}}, "experimental": "enabled"/g' "${DOCKER_CONFIG}/config.json"

          docker -D manifest create \
              "ssbkang/portainer:$CONTAINER_IMAGE_TAG" \
              "ssbkang/portainer:$CONTAINER_IMAGE_TAG-linux-amd64" \
              "ssbkang/portainer:$CONTAINER_IMAGE_TAG-windows1809-amd64"
          docker -D manifest push "ssbkang/portainer:$CONTAINER_IMAGE_TAG"
